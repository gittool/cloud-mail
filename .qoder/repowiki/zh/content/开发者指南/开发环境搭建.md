# 开发环境搭建

<cite>
**本文档引用的文件**  
- [mail-vue/package.json](file://mail-vue/package.json)
- [mail-worker/package.json](file://mail-worker/package.json)
- [mail-vue/vite.config.js](file://mail-vue/vite.config.js)
- [mail-worker/wrangler.toml](file://mail-worker/wrangler.toml)
- [mail-worker/wrangler-dev.toml](file://mail-worker/wrangler-dev.toml)
- [doc/github-action.md](file://doc/github-action.md)
</cite>

## 目录
1. [简介](#简介)
2. [基础环境安装](#基础环境安装)
3. [项目依赖安装](#项目依赖安装)
4. [开发服务器与代理配置](#开发服务器与代理配置)
5. [Wrangler CLI 配置与验证](#wrangler-cli-配置与验证)
6. [常见问题与解决方案](#常见问题与解决方案)
7. [总结](#总结)

## 简介
本文档为开发者提供完整的本地开发环境搭建指南，涵盖Node.js、pnpm、Cloudflare Wrangler等工具的安装与配置。重点说明前后端项目（mail-vue 和 mail-worker）的依赖管理、开发服务器设置及通信机制，帮助新开发者快速启动项目并解决常见环境问题。

## 基础环境安装

### 安装 Node.js（v18+）
本项目要求 Node.js 版本不低于 v18。建议使用 [Node.js 官网](https://nodejs.org/) 下载 LTS 版本，或通过版本管理工具如 `nvm` 进行安装：

```bash
# 使用 nvm 安装并切换到 Node.js v18
nvm install 18
nvm use 18
```

验证安装是否成功：
```bash
node -v  # 输出应为 v18.x.x 或更高
npm -v   # 确保 npm 可用
```

### 安装 pnpm 包管理器
`pnpm` 是本项目使用的包管理工具，相比 `npm` 更高效且节省磁盘空间。

```bash
# 使用 npm 全局安装 pnpm
npm install -g pnpm
```

验证安装：
```bash
pnpm -v  # 应输出版本号
```

### 安装 Cloudflare Wrangler CLI
`wrangler` 是 Cloudflare Workers 的命令行工具，用于本地开发、部署和管理 Worker 项目。

根据 `mail-worker/package.json` 文件中的依赖信息，项目使用的是 `wrangler@^4.7.0`，且 `pnpm-lock.yaml` 显示实际版本为 `4.33.1`，要求 Node.js >=18.0.0。

```bash
# 全局安装 wrangler
npm install -g wrangler
```

验证安装：
```bash
wrangler --version  # 应输出 4.x.x 版本
```

**Section sources**
- [mail-worker/package.json](file://mail-worker/package.json#L7-L10)
- [mail-worker/pnpm-lock.yaml](file://mail-worker/pnpm-lock.yaml#L2224-L2264)

## 项目依赖安装

### 前端项目（mail-vue）
进入 `mail-vue` 目录并安装依赖：

```bash
cd mail-vue
pnpm install
```

该命令将根据 `package.json` 安装所有生产与开发依赖，包括 Vue 3、Element Plus、Axios 等核心库。

### 后端项目（mail-worker）
进入 `mail-worker` 目录并安装依赖：

```bash
cd mail-worker
pnpm install
```

此项目依赖 `wrangler`、`hono`（轻量级 Web 框架）、`resend`（邮件发送）、`drizzle-orm`（数据库操作）等。

**Section sources**
- [mail-vue/package.json](file://mail-vue/package.json#L11-L42)
- [mail-worker/package.json](file://mail-worker/package.json#L11-L29)

## 开发服务器与代理配置

### Vite 开发服务器配置（vite.config.js）
前端项目使用 Vite 作为构建工具，其配置文件位于 `mail-vue/vite.config.js`。

关键配置项如下：
- **服务器监听地址与端口**：`server.host = true` 允许外部访问，`port: 3001` 指定开发服务器运行在 3001 端口。
- **热更新（HMR）**：启用以支持代码修改后自动刷新。
- **别名配置**：`@` 指向 `src` 目录，便于模块导入。
- **PWA 支持**：通过 `vite-plugin-pwa` 实现渐进式 Web 应用功能。
- **构建输出目录**：`outDir: env.VITE_OUT_DIR || 'dist'`，默认为 `dist`。

```js
server: {
  host: true,
  port: 3001,
  hmr: true,
}
```

### 前后端通信代理机制
本项目未在 `vite.config.js` 中显式配置代理（如 `proxy`），而是通过以下方式实现通信：
- 后端 Worker 部署后提供统一入口（如 `https://your-worker.your-subdomain.workers.dev`）。
- 前端通过环境变量 `VITE_API_BASE_URL` 动态设置请求基地址，指向 Worker 接口。
- 在 `wrangler.toml` 中，`[assets]` 配置将前端构建产物（`dist`）托管为静态资源，并通过 `run_worker_first = true` 实现单页应用（SPA）路由支持。

**Section sources**
- [mail-vue/vite.config.js](file://mail-vue/vite.config.js#L10-L61)
- [mail-worker/wrangler.toml](file://mail-worker/wrangler.toml#L25-L32)

## Wrangler CLI 配置与验证

### 登录 Cloudflare 账户
首次使用需通过以下命令登录：

```bash
wrangler login
```

该命令会打开浏览器，引导用户授权 Wrangler 访问 Cloudflare 账户。

### 验证环境配置
可通过以下命令验证当前配置是否正确：

```bash
wrangler whoami
```

输出应包含账户名称和 ID，确认登录状态有效。

### 使用不同环境配置文件
项目包含多个 Wrangler 配置文件：
- `wrangler.toml`：生产环境配置，绑定 D1、KV、R2 等资源。
- `wrangler-dev.toml`：开发环境配置，包含测试域名、管理员邮箱和 JWT 密钥等示例变量。
- `wrangler-action.toml`：用于 GitHub Actions 部署，使用环境变量占位符。

开发时建议使用 `wrangler-dev.toml`：
```bash
wrangler dev --config wrangler-dev.toml
```

**Section sources**
- [mail-worker/wrangler.toml](file://mail-worker/wrangler.toml#L0-L40)
- [mail-worker/wrangler-dev.toml](file://mail-worker/wrangler-dev.toml#L0-L29)
- [doc/github-action.md](file://doc/github-action.md#L4-L22)

## 常见问题与解决方案

### 端口冲突（3001 端口被占用）
若 `pnpm dev` 启动失败，提示端口占用，可修改 `vite.config.js` 中的 `port` 值，或终止占用进程：

```bash
# 查找占用 3001 端口的进程
lsof -i :3001
# 终止进程（替换 PID）
kill -9 <PID>
```

### 依赖版本不匹配
若出现依赖错误，建议清除缓存后重新安装：

```bash
pnpm clean
pnpm install
```

或使用 `--force` 强制重新解析依赖。

### Wrangler 权限错误
确保已正确登录且 API Token 具备以下权限：
- Account: Workers Scripts (Edit)
- Account: Workers KV Namespace (Edit)
- Account: Workers D1 Databases (Edit)
- Account: Workers R2 Bucket (Edit)

相关密钥应在 `wrangler-dev.toml` 或环境变量中正确配置。

### 数据库与 KV 初始化失败
检查 `wrangler-dev.toml` 中的 `database_id` 和 `kv.id` 是否有效。若使用本地开发，可借助 Wrangler 的 `--local` 模式进行调试。

### 构建命令执行失败
`wrangler.toml` 中的 `[build]` 命令会自动构建前端：
```toml
[build]
command = "pnpm --prefix ../mail-vue install && pnpm --prefix ../mail-vue run build"
```
确保路径正确且 `pnpm` 可执行。

**Section sources**
- [mail-worker/wrangler.toml](file://mail-worker/wrangler.toml#L34-L40)
- [mail-worker/wrangler-dev.toml](file://mail-worker/wrangler-dev.toml#L20-L29)

## 总结
本文档详细介绍了 Cloud Mail 项目的本地开发环境搭建流程，涵盖 Node.js、pnpm、Wrangler 的安装与配置，前后端依赖管理，Vite 服务器设置及常见问题解决方案。开发者可依据此指南快速启动项目，确保开发环境一致性，提升协作效率。