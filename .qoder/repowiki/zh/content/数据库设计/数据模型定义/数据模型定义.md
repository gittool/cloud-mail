
# 数据模型定义

<cite>
**本文档中引用的文件**  
- [user.js](file://mail-worker/src/entity/user.js)
- [account.js](file://mail-worker/src/entity/account.js)
- [email.js](file://mail-worker/src/entity/email.js)
- [att.js](file://mail-worker/src/entity/att.js)
- [role.js](file://mail-worker/src/entity/role.js)
- [perm.js](file://mail-worker/src/entity/perm.js)
- [setting.js](file://mail-worker/src/entity/setting.js)
- [star.js](file://mail-worker/src/entity/star.js)
- [reg-key.js](file://mail-worker/src/entity/reg-key.js)
- [verify-record.js](file://mail-worker/src/entity/verify-record.js)
</cite>

## 目录
1. [简介](#简介)
2. [核心数据模型](#核心数据模型)
   - [User（用户）](#user用户)
   - [Account（邮箱账户）](#account邮箱账户)
   - [Email（邮件）](#email邮件)
   - [Attachment（附件）](#attachment附件)
   - [Role（角色）](#role角色)
   - [Perm（权限）](#perm权限)
   - [Setting（系统设置）](#setting系统设置)
   - [Star（星标）](#star星标)
   - [RegKey（注册密钥）](#regkey注册密钥)
   - [VerifyRecord（验证记录）](#verifyrecord验证记录)
3. [模型关系图](#模型关系图)
4. [业务规则与实现逻辑](#业务规则与实现逻辑)
5. [API 序列化示例](#api-序列化示例)

## 简介
本文档详细描述了 `cloud-mail` 项目中的核心数据模型，涵盖 `User`、`Account`、`Email`、`Attachment`、`Role`、`Perm`、`Setting`、`Star`、`RegKey` 和 `VerifyRecord` 十个实体。每个模型均说明其字段定义、类型、默认值、约束条件、主键设计及业务含义，并提供 JSON 示例和 API 表现形式。所有模型基于 Drizzle ORM 定义，存储于 SQLite 数据库中。

## 核心数据模型

### User（用户）
表示系统中的用户实体，包含身份认证、状态、设备信息等。

**字段说明：**
- `userId`: 整数，主键，自增。
- `email`: 文本，非空，唯一标识用户。
- `type`: 整数，用户角色类型，默认为 1。
- `password`: 文本，非空，加密后的密码。
- `salt`: 文本，非空，密码盐值。
- `status`: 整数，用户状态，默认为 0（正常）。
- `createTime`: 文本，创建时间，默认为当前时间戳。
- `activeTime`: 文本，最后活跃时间。
- `createIp`: 文本，注册 IP。
- `activeIp`: 文本，最近登录 IP。
- `os`, `browser`, `device`: 文本，记录用户设备信息。
- `sort`: 文本，排序字段，默认为 0。
- `sendCount`: 文本，发送邮件计数，默认为 0。
- `regKeyId`: 整数，关联注册密钥 ID，默认为 0。
- `isDel`: 整数，软删除标志，默认为 0（未删除）。

**业务规则：**
- 用户状态枚举：0=正常，其他值可能表示封禁或待激活。
- `createTime` 使用 `CURRENT_TIMESTAMP` 自动生成。
- 邮箱不区分大小写查询（通过 `COLLATE NOCASE` 实现）。

**JSON 示例：**
```json
{
  "userId": 1001,
  "email": "user@example.com",
  "type": 1,
  "status": 0,
  "createTime": "2025-04-05 10:00:00",
  "activeTime": "2025-04-05 10:05:00",
  "createIp": "192.168.1.1",
  "os": "Windows",
  "browser": "Chrome",
  "device": "PC",
  "sendCount": "5",
  "regKeyId": 101,
  "isDel": 0
}
```

**API 序列化表现：**
在 `/user/list` 接口中返回用户列表，排除 `password` 和 `salt` 字段。

**节来源**
- [user.js](file://mail-worker/src/entity/user.js#L2-L20)
- [user-service.js](file://mail-worker/src/service/user-service.js#L40-L91)

### Account（邮箱账户）
表示用户拥有的邮箱账户，支持多账户管理。

**字段说明：**
- `accountId`: 整数，主键，自增。
- `email`: 文本，非空，账户邮箱地址。
- `name`: 文本，非空，默认为空字符串，账户显示名。
- `status`: 整数，状态，默认为 0（启用）。
- `latestEmailTime`: 文本，最后接收邮件时间。
- `createTime`: 文本，创建时间，默认为当前时间戳。
- `userId`: 整数，非空，外键关联用户。
- `isDel`: 整数，软删除标志，默认为 0。

**业务规则：**
- 一个用户可拥有多个邮箱账户。
- 账户邮箱用于接收外部邮件，由 `email` 服务监听。

**JSON 示例：**
```json
{
  "accountId": 2001,
  "email": "inbox@user.com",
  "name": "主邮箱",
  "status": 0,
  "createTime": "2025-04-05 10:00:00",
  "userId": 1001,
  "isDel": 0
}
```

**节来源**
- [account.js](file://mail-worker/src/entity/account.js#L2-L11)

### Email（邮件）
表示系统中的一封邮件，包含收发信息、内容及状态。

**字段说明：**
- `emailId`: 整数，主键，自增。
- `sendEmail`: 文本，发件人邮箱。
- `name`: 文本，发件人姓名。
- `accountId`: 整数，非空，所属账户 ID。
- `userId`: 整数，非空，所属用户 ID。
- `subject`: 文本，邮件主题。
- `text`: 文本，纯文本内容。
- `content`: 文本，HTML 内容。
- `cc`, `bcc`: 文本，抄送/密送列表，JSON 数组格式，默认为 `"[]"`。
- `recipient`: 文本，收件人列表，JSON 数组格式。
- `toEmail`, `toName`: 文本，主收件人邮箱与姓名，非空，默认为空。
- `inReplyTo`, `relation`: 文本，回复引用字段。
- `messageId`: 文本，邮件唯一标识符，来自原始邮件头。
- `type`: 整数，邮件类型，默认为 0（接收）。
- `status`: 整数，处理状态，默认为 0（保存中）。
- `resendEmailId`: 文本，重发任务 ID。
- `message`: 文本，处理消息。
- `createTime`: 文本，创建时间，非空，默认为当前时间戳。
- `isDel`: 整数，软删除标志，默认为 0。

**业务规则：**
- `messageId` 用于防止重复接收。
- `type` 枚举：0=接收，1=发送。
- `status` 枚举：0=保存中，1=已接收，2=无人接收。
- 使用 `PostalMime` 解析原始邮件内容。
- 附件通过 `key` 字段关联至对象存储。

**JSON 示例：**
```json
{
  "emailId": 3001,
  "sendEmail": "sender@domain.com",
  "name": "Sender",
  "subject": "测试邮件",
  "content": "<p>这是一封测试邮件</p>",
  "toEmail": "inbox@user.com",
  "toName": "主邮箱",
  "messageId": "<abc123@example.com>",
  "type": 0,
  "status": 1,
  "createTime": "2025-04-05 10:10:00",
  "isDel": 0
}
```

**API 序列化表现：**
`/email/list` 接口返回时，会附加 `isStar` 字段和 `attList` 附件列表。

**节来源**
- [email.js](file://mail-worker/src/entity/email.js#L2-L25)
- [email.js](file://mail-worker/src/email/email.js#L19-L225)

### Attachment（附件）
表示邮件中的附件文件。

**字段说明：**
- `attId`: 整数，主键，自增。
- `userId`, `emailId`, `accountId`: 整数，非空，关联用户、邮件和账户。
- `key`: 文本，非空，对象存储中的唯一键。
- `filename`: 文本，原始文件名。
- `mimeType`: 文本，MIME 类型。
- `size`: 整数，文件大小（字节）。
- `status`: 文本，状态，默认为 "0"。
- `type`: 整数，类型，默认为 0（普通附件）。
- `disposition`: 文本，内容处置方式（如 attachment/inline）。
- `related`: 文本，相关引用。
- `contentId`: 文本，内嵌资源 ID（如 CID）。
- `encoding`: 文本，编码方式。
- `createTime`: 文本，创建时间，非空，默认为当前时间戳。

**业务规则：**
- `key` 由文件内容哈希生成，确保唯一性。
- 支持内嵌图片（通过 `contentId` 关联 HTML）。
- 存储于 R2 或 S3 兼容服务。

**JSON 示例：**
```json
{
  "attId": 4001,
  "emailId": 3001,
  "filename": "image.png",
  "mimeType": "image/png",
  "size": 10240,
  "key": "att_abc123.png",
  "contentId": "<image001>",
  "createTime": "2025-04-05 10:10:05"
}
```

**节来源**
- [att.js](file://mail-worker/src/entity/att.js#L3-L19)

### Role（角色）
定义用户角色及其权限配置。

**字段说明：**
- `roleId`: 整数，主键，自增。
- `name`: 文本，非空，角色名称。
- `key`: 文本，非空，角色键。
- `description`: 文本，描述。
- `banEmail`: 文本，非空，禁止的邮箱列表，逗号分隔。
- `banEmailType`: 整数，禁止类型，默认为 0。
- `availDomain`: 文本，可用域名白名单。
- `sort`: 整数，排序。
- `isDefault`: 整数，是否默认角色，默认为 0。
- `createTime`: 文本，创建时间，非空，默认为当前时间戳。
- `userId`: 整数，创建者用户 ID。
- `sendCount`: 整数，允许发送数量。
- `sendType`: 文本，发送类型，默认为 "count"。
- `accountCount`: 整数，允许添加的账户数量。

**业务规则：**
- 用户注册时根据 `regKey` 分配角色。
- `banEmail` 支持通配符 `*` 和域名过滤。
- `availDomain` 控制用户可使用的邮箱域名。

**JSON 示例：**
```json
{
  "roleId": 5001,
  "name": "普通用户",
  "key": "user",
  "banEmail": "spam@domain.com",
  "availDomain": "example.com",
  "sendCount": 100,
  "accountCount": 3,
  "createTime": "2025-04-05 09:00:00"
}
```

**节来源**
- [role.js](file://mail-worker/src/entity/role.js#L2-L17)

### Perm（权限）
定义系统权限节点，用于角色授权。

**字段说明：**
- `permId`: 整数，主键，自增。
- `name`: 文本，非空，权限名称。
- `permKey`: 文本，权限键。
- `pid`: 整数，非空，父级 ID，默认为 0（根节点）。
- `type`: 整数，非空，类型，默认为 2。
- `sort`: 整数，排序。

**业务规则：**
- 权限树结构，`pid` 表示层级关系。
- `type` 可能区分菜单、按钮等。

**JSON 示例：**
```json
{
  "permId": 6001,
  "name": "用户管理",
  "permKey": "user:manage",
  "pid": 0,
  "type": 2,
  "sort": 1
}
```

**节来源**
- [perm.js](file://mail-worker/src/entity/perm.js#L1-L8)

### Setting（系统设置）
全局系统配置，单记录表。

**字段说明：**
- `register`: 整数，注册开关。
- `receive`: 整数，接收开关。
- `title`: 文本，站点标题。
- `manyEmail`: 整数，多邮箱支持。
- `addEmail`: 整数，添加邮箱开关。
- `autoRefreshTime`: 整数，自动刷新时间（秒）。
- `addEmailVerify`: 整数，添加邮箱是否验证。
- `registerVerify`: 整数，注册是否验证。
- `regVerifyCount`: 整数，注册验证次数限制。
- `addVerifyCount`: 整数，添加邮箱验证次数限制。
- `send`: 整数，发送功能开关。
- `r2Domain`: 文本，R2 自定义域名。
- `secretKey`, `siteKey`: 文本，验证码密钥。
- `regKey`: 整数，注册密钥模式。
- `background`: 文本，背景图。
- `tgBotToken`, `tgChatId`: 文本，Telegram 通知配置。
- `tgBotStatus`: 整数，Telegram 通知开关。
- `forwardEmail`: 文本，转发邮箱列表。
- `forwardStatus`: 整数，转发功能开关。
- `ruleEmail`: 文本，规则邮箱列表。
- `ruleType`: 整数，规则类型。
- `loginOpacity`: 浮点数，登录页透明度。
- `resendTokens`: 文本，重发令牌 JSON。
- `notice*`: 文本/整数，通知配置。
- `noRecipient`: 整数，无收件人处理。
- `loginDomain`: 整数，登录域名限制。
- `bucket`, `region`, `endpoint`, `s3AccessKey`, `s3SecretKey`: 文本，S3 存储配置。

**业务规则：**
- 所有字段均有默认值，确保系统可运行。
- 多数开关类字段：0=关闭，1=开启。

**JSON 示例：**
```json
{
  "register": 1,
  "receive": 1,
  "title": "Cloud Mail",
  "send": 1,
  "tgBotStatus": 1,
  "forwardStatus": 0,
  "ruleType": 0
}
```

**节来源**
- [setting.js](file://mail-worker/src/entity/setting.js#L1-L42)

### Star（星标）
记录用户对邮件的星标操作。

**字段说明：**
- `starId`: 整数，主键，自增。
- `userId`: 整数，非空，用户 ID。
- `emailId`: 整数，非空，邮件 ID。
- `createTime`: 文本，创建时间，非空，默认为当前时间戳。

**业务规则：**
- 联合主键为 `(userId, emailId)`，确保唯一性。
- 用于标记重要邮件。

**JSON 示例：**
```json
{
  "starId": 7001,
  "userId": 1001,
  "emailId": 3001,
  "createTime": "2025-04-05 10:15:00"
}
```

**节来源**
- [star.js](file://mail-worker/src/entity/star.js#L3-L10)

### RegKey（注册密钥）
用于控制用户注册的邀请码系统。

**字段说明：**
- `regKeyId`: 整数，主键，自增。
- `code`: 文本，非空，默认为空，邀请码。
- `count`: 整数，非空，默认为 0，已使用次数。
- `roleId`: 整数，非空，默认为 0，关联角色 ID。
- `userId`: 整数，非空，默认为 0，创建者 ID。
- `expireTime`: 文本，过期时间。
- `createTime`: 文本，创建时间，非空，默认为当前时间戳。

**业务规则：**
- 用户注册时需提供有效 `code`。
- `count` 递增，达到限制后失效。

**JSON 示例：**
```json
{
  "regKeyId": 8001,
  "code": "ABC123",
  "count": 5,
  "roleId": 5001,
  "createTime": "2025-04-01 00:00:00",
  "expireTime": "2025-05-01 00:00:00"
}
```

**节来源**
- [reg-key.js](file://mail-worker/src/entity/reg-key.js#L2-L10)

### VerifyRecord（验证记录）
记录用户操作的验证状态，防止滥用。

**字段说明：**
- `vrId`: 整数，主键，自增。
- `ip`: 整数，非空，默认为空，客户端 IP。
- `count`: 整数，非空，默认为 1，尝试次数。
- `type`: 整数，非空，默认为 0，验证类型。
- `updateTime`: 文本，更新时间，非空，默认为当前时间戳。

**业务规则：**
- `type` 枚举：0=注册验证，1=添加邮箱验证。
- 用于频率限制，如注册验证码请求。
- IP 地址用于追踪来源。

**JSON 示例：**
```json
{
  "vrId": 9001,
  "ip": "192.168.1.1",
  "count": 3,
  "type": 0,
  "updateTime": "2025-04-05 10:02:00"
}
```

**节来源**
- [verify-record.js](file://mail-worker/src/entity/verify-record.js#L2-L8)
- [verify-record-service.js](file://mail-worker/src/service/verify-record-service.js#L7-L87)

## 模型关系图

```mermaid
erDiagram
  USER {
    integer user_id PK
    text email UK
    integer type
    text password
    text salt
    integer status
    text create_time
    text active_time
    text create_ip
    text active_ip
    text os
    text browser
    text device
    text sort
    text send_count
    integer reg_key_id FK
    integer is_del
  }

  ACCOUNT {
    integer account_id PK
    text email
    text name
    integer status
    text latest_email_time
    text create_time
    integer user_id FK
    integer is_del
  }

  EMAIL {
    integer email_id PK
    text send_email
    text name
    integer account_id FK
    integer user_id FK
    text subject
    text text
    text content
    text cc
    text bcc
    text recipient
    text to_email
    text to_name
    text in_reply_to
    text relation
    text message_id
    integer type
    integer status
    text resend_email_id
    text message
    text create_time
    integer is_del
  }

  ATTACHMENTS {
    integer att_id PK
    integer user_id FK
    integer email_id FK
    integer account_id FK
    text key UK
    text filename
    text mime_type
    integer size
    text status
    integer type
    text disposition
    text related
    text content_id
    text encoding
    text create_time
  }

  ROLE {
    integer role_id PK
    text name
    text key UK
    text description
    text ban_email
    integer ban_email_type
    text avail_domain
    integer sort
    integer is_default
    text create_time
    integer user_id
    integer send_count
    text send_type
    integer account_count
  }

  PERM {
    integer perm_id PK
    text name
    text perm_key UK
    integer pid
    integer type
    integer sort
  }

  SETTING {
    integer register
    integer receive
    text title
    integer many_email
    integer add_email
    integer auto_refresh_time
    integer add_email_verify
    integer register_verify
    integer reg_verify_count
    integer add_verify_count
    integer send
    text r2_domain
    text secret_key
    text site_key
    integer reg_key
    text background
    text tg_bot_token
    text tg_chat_id
    integer tg_bot_status
    text forward_email
    integer forward_status
    text rule_email
    integer rule_type
    real login_opacity
    text resend_tokens
   