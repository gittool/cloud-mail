# 多账户管理

<cite>
**本文档引用文件**  
- [account.vue](file://mail-vue/src/layout/account/index.vue)
- [account.js](file://mail-vue/src/store/account.js)
- [account.js](file://mail-worker/src/entity/account.js)
- [account-service.js](file://mail-worker/src/service/account-service.js)
- [request/account.js](file://mail-vue/src/request/account.js)
</cite>

## 目录
1. [简介](#简介)
2. [前端账户管理组件](#前端账户管理组件)
3. [账户状态管理（Pinia Store）](#账户状态管理pinia-store)
4. [后端账户服务逻辑](#后端账户服务逻辑)
5. [账户与用户实体关系](#账户与用户实体关系)
6. [R2对象存储中的数据隔离策略](#r2对象存储中的数据隔离策略)
7. [账户切换流程图](#账户切换流程图)
8. [典型使用场景](#典型使用场景)
9. [常见问题与解决方案](#常见问题与解决方案)

## 简介
`cloud-mail`系统支持多邮箱账户管理功能，允许用户绑定多个邮箱地址并自由切换主账户。该功能涵盖前端视图组件、状态管理、后端业务接口及数据隔离机制。本文档详细说明账户的添加、切换、删除和命名逻辑，解析前后端交互流程，并提供典型使用场景与问题排查方案。

## 前端账户管理组件

`account.vue` 是负责展示和操作账户列表的核心视图组件。用户可通过该界面查看所有已绑定账户、添加新账户、重命名账户或删除非主账户。

主要功能包括：
- **账户列表展示**：通过无限滚动加载账户分页数据。
- **账户切换**：点击任一账户项即可设为当前主账户。
- **账户添加**：支持输入邮箱并完成人机验证后提交。
- **账户重命名**：允许修改账户显示名称。
- **账户复制与删除**：提供邮箱复制功能及删除确认对话框。

组件通过调用 `accountList`、`accountAdd`、`accountSetName` 和 `accountDelete` 等 API 实现与后端通信。

**Section sources**
- [account.vue](file://mail-vue/src/layout/account/index.vue#L0-L378)

## 账户状态管理（Pinia Store）

`account.js`（Pinia 模块）用于集中管理账户相关的全局状态，确保跨组件状态一致性。

核心状态字段如下：
- `currentAccountId`：当前激活账户的唯一标识。
- `currentAccount`：当前账户的完整对象信息。
- `changeUserAccountName`：用于同步主账户名称变更的监听字段。

账户切换操作通过 `changeAccount(account)` 方法更新状态，触发视图刷新。此外，当主账户名称修改时，会同步更新 `userStore` 中的用户名称以保持一致性。

**Section sources**
- [account.js](file://mail-vue/src/store/account.js#L2-L8)
- [account.vue](file://mail-vue/src/layout/account/index.vue#L260-L265)

## 后端账户服务逻辑

`account-service.js` 提供完整的账户管理业务逻辑，封装了账户的增删改查及权限校验流程。

### 主要接口说明

| 接口方法 | 路径 | 功能描述 |
|--------|------|---------|
| `add` | `/account/add` | 添加新账户，需通过域名、权限及人机验证 |
| `list` | `/account/list` | 分页查询用户所属账户列表 |
| `delete` | `/account/delete` | 删除指定账户（不可删除主账户） |
| `setName` | `/account/setName` | 修改账户显示名称 |

### 添加账户逻辑流程
1. 校验系统是否开启多账户功能。
2. 验证邮箱格式及所属域名是否在允许范围内。
3. 检查账户是否已存在或已被删除。
4. 根据用户角色判断账户数量配额。
5. 若启用验证机制，则执行 Turnstile 人机验证。
6. 插入数据库并返回结果。

### 权限与限制
- 普通用户受角色中 `accountCount` 字段限制。
- 用户只能操作自己名下的账户。
- 主账户（即注册邮箱）不可删除。

**Section sources**
- [account-service.js](file://mail-worker/src/service/account-service.js#L0-L231)
- [request/account.js](file://mail-vue/src/request/account.js#L6-L8)

## 账户与用户实体关系

账户（`account`）与用户（`user`）通过 `userId` 字段建立关联关系，形成一对多结构。

### 数据模型对比

#### 用户实体（user）
```js
{
  userId: integer,
  email: text,         // 主账户邮箱
  type: integer,       // 角色类型
  password: text,
  salt: text,
  isDel: integer
}
```

#### 账户实体（account）
```js
{
  accountId: integer,
  email: text,         // 绑定邮箱
  name: text,          // 显示名称
  userId: integer,     // 关联用户ID
  isDel: integer       // 删除状态
}
```

- 一个 `user` 可拥有多个 `account`。
- `user.email` 为主账户，自动作为第一个 `account` 记录。
- 所有账户操作均需验证 `userId` 一致性，防止越权访问。

**Section sources**
- [account.js](file://mail-worker/src/entity/account.js#L0-L13)
- [user.js](file://mail-worker/src/entity/user.js#L0-L22)

## R2对象存储中的数据隔离策略

为确保不同账户上传的附件相互隔离，系统采用基于账户ID的路径前缀策略进行对象存储（R2/S3）组织。

### 存储键（Key）生成规则
附件存储路径格式为：
```
att/{accountId}/{uuid}/{filename}
```

其中：
- `accountId`：确保不同账户附件物理隔离。
- `uuid`：唯一文件标识。
- `filename`：原始文件名。

此设计保证即使多个账户上传同名文件也不会冲突，且便于按账户粒度进行数据清理或迁移。

### 访问控制
- 所有文件读写操作均通过 `r2-service.js` 封装。
- 写入时自动附加 `accountId` 到路径。
- 读取时校验请求上下文中的 `userId` 与目标 `accountId` 的归属关系。

**Section sources**
- [r2-service.js](file://mail-worker/src/service/r2-service.js#L0-L53)
- [att.js](file://mail-worker/src/entity/att.js#L0-L21)
- [convert.js](file://mail-vue/src/utils/convert.js#L0-L40)

## 账户切换流程图

```mermaid
flowchart TD
A[用户点击账户项] --> B{调用 changeAccount(account)}
B --> C[更新 Pinia Store 中 currentAccountId]
C --> D[更新 currentAccount 对象]
D --> E[触发响应式更新]
E --> F[主界面监听 accountId 变化]
F --> G[重新加载邮件列表]
G --> H[刷新附件预览链接]
H --> I[完成账户切换]
```

**Diagram sources**
- [account.vue](file://mail-vue/src/layout/account/index.vue#L260-L265)
- [account.js](file://mail-vue/src/store/account.js#L2-L8)

## 典型使用场景

### 场景一：用户绑定第二个邮箱并设为主账户
1. 用户进入“账户管理”页面。
2. 点击“添加”按钮，输入新邮箱并完成人机验证。
3. 系统调用 `/account/add` 接口创建账户。
4. 新账户出现在列表中，用户点击该账户完成切换。
5. 前端状态更新，邮件列表加载新账户收件箱。

### 场景二：管理员为用户批量创建账户
1. 管理员调用内部 API 批量插入 `account` 记录。
2. 设置 `userId` 指向目标用户。
3. 用户登录后自动加载所有账户。
4. 用户可自由选择任一账户作为当前操作主体。

**Section sources**
- [account-service.js](file://mail-worker/src/service/account-service.js#L0-L231)
- [account.vue](file://mail-vue/src/layout/account/index.vue#L0-L378)

## 常见问题与解决方案

### 问题一：账户切换后缓存未更新
**现象**：切换账户后仍显示旧账户邮件。
**原因**：邮件列表组件未监听 `currentAccountId` 变化。
**解决方案**：
- 在 `email-list.vue` 中添加对 `accountStore.currentAccountId` 的 `watch` 监听。
- 账户切换时主动触发 `refreshEmailList()` 方法。

### 问题二：权限继承异常
**现象**：次级账户无法发送邮件或访问设置。
**原因**：角色权限未正确继承至非主账户。
**解决方案**：
- 所有权限判断应基于 `user.type` 而非 `account` 属性。
- 确保 `hasPerm()` 方法使用 `userStore.user.type` 进行校验。

### 问题三：附件路径错乱
**现象**：附件无法加载或显示他人文件。
**原因**：存储路径未包含 `accountId`。
**解决方案**：
- 强制所有附件上传路径包含 `accountId` 前缀。
- 下载时校验当前 `accountId` 与路径中 `accountId` 是否一致。

**Section sources**
- [account.js](file://mail-vue/src/store/account.js#L2-L8)
- [r2-service.js](file://mail-worker/src/service/r2-service.js#L0-L53)
- [account.vue](file://mail-vue/src/layout/account/index.vue#L260-L265)