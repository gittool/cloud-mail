# 前端构建与部署

<cite>
**本文档引用的文件**  
- [vite.config.js](file://mail-vue/vite.config.js)
- [package.json](file://mail-vue/package.json)
- [jsconfig.json](file://mail-vue/jsconfig.json)
- [github-action.md](file://doc/github-action.md)
</cite>

## 目录
1. [简介](#简介)
2. [构建配置详解](#构建配置详解)
3. [执行构建与输出结构](#执行构建与输出结构)
4. [静态资源部署](#静态资源部署)
5. [CI/CD 自动化流程](#cicd-自动化流程)
6. [环境变量与安全配置](#环境变量与安全配置)
7. [缓存策略与版本控制](#缓存策略与版本控制)
8. [常见构建问题与调试方法](#常见构建问题与调试方法)
9. [最佳实践建议](#最佳实践建议)

## 简介
本文档旨在为 `mail-vue` 前端应用提供完整的构建与部署指南。涵盖 Vite 构建配置、静态资源生成、手动与自动化部署流程，以及 CI/CD 集成方案。通过本指南，开发者可掌握如何配置构建路径、执行构建命令、部署至 Cloudflare Pages，并实现代码推送后的自动构建、测试与发布。

## 构建配置详解

`vite.config.js` 是 `mail-vue` 项目的核心构建配置文件，定义了开发服务器、构建输出、资源路径及插件集成等关键设置。

### 构建输出路径配置
构建输出目录通过 `build.outDir` 指定，支持环境变量覆盖：
```js
outDir: env.VITE_OUT_DIR || 'dist'
```
默认输出至 `dist` 目录，可通过设置 `VITE_OUT_DIR` 环境变量自定义输出路径。

### 公共基础路径（Base URL）
基础路径由 `base` 字段控制，用于指定资源的公共前缀：
```js
base: env.VITE_STATIC_URL || '/'
```
若未设置 `VITE_STATIC_URL`，则使用根路径 `/`。此配置影响所有静态资源（JS、CSS、图片等）的引用路径，适用于部署在子目录的场景。

### 资源优化与包含规则
构建时可指定额外包含的资源类型：
```js
assetsInclude: ['**/*.json']
```
确保 JSON 文件被正确处理为静态资源，避免加载失败。

### 别名配置
通过 `resolve.alias` 设置路径别名，提升模块导入可读性：
```js
alias: {
  '@': path.resolve(__dirname, 'src')
}
```
结合 `jsconfig.json` 中的路径映射，支持 IDE 智能提示与跳转。

### PWA 支持配置
项目集成 `vite-plugin-pwa`，生成 PWA 清单文件：
```js
manifest: {
  name: env.VITE_PWA_NAME,
  short_name: env.VITE_PWA_NAME,
  icons: [{ src: 'mail-pwa.png', sizes: '192x192' }]
}
```
PWA 名称与图标路径由环境变量控制，支持多环境定制。

**Section sources**
- [vite.config.js](file://mail-vue/vite.config.js#L1-L61)

## 执行构建与输出结构

### 构建命令
项目通过 `package.json` 中的脚本定义构建流程：
```json
"scripts": {
  "build": "vite build --mode release",
  "eo": "vite build --mode eo"
}
```
- `pnpm build`：以 `release` 模式构建生产环境资源
- `pnpm eo`：以 `eo` 模式构建特定环境资源

构建过程会加载对应模式的环境变量文件（如 `.env.release`），并应用 `vite.config.js` 中的配置。

### 输出目录结构
执行 `pnpm build` 后，生成 `dist` 目录，包含：
- `index.html`：入口 HTML 文件
- `assets/`：打包后的 JS、CSS 及静态资源
- `tinymce/`：富文本编辑器静态资源（来自 `public` 目录）
- `mail-pwa.png`：PWA 图标

所有资源路径均基于 `base` 配置生成，确保在部署路径下正确加载。

**Section sources**
- [package.json](file://mail-vue/package.json#L0-L42)
- [vite.config.js](file://mail-vue/vite.config.js#L16-L55)

## 静态资源部署

### 部署至 Cloudflare Pages
1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com)
2. 进入 **Pages** → **Projects** → **Create a project**
3. 连接 GitHub 仓库 `cloud-mail`
4. 配置构建设置：
   - **Framework preset**: 选择 `Vite`
   - **Build command**: `pnpm build`
   - **Build output directory**: `dist`
5. 部署完成后，应用将通过 `your-project.pages.dev` 访问

### 部署至其他静态托管服务
- **Vercel**: 导入项目，自动识别 Vite 配置，构建命令为 `pnpm build`
- **Netlify**: 在 `netlify.toml` 中配置：
  ```toml
  [build]
    command = "pnpm build"
    publish = "dist"
  ```
- **GitHub Pages**: 使用 GitHub Actions 将 `dist` 目录推送到 `gh-pages` 分支

**Section sources**
- [vite.config.js](file://mail-vue/vite.config.js#L55-L58)

## CI/CD 自动化流程

### GitHub Actions 集成
项目通过 `doc/github-action.md` 提供了完整的 CI/CD 配置指南。

#### 工作流触发机制
- **代码推送触发**：当向主分支推送代码时，自动触发构建与部署流程
- **手动触发**：可在 GitHub Actions 页面手动运行工作流

#### 自动化流程步骤
1. **检出代码**：`actions/checkout@v4`
2. **设置 Node.js 环境**：`actions/setup-node@v4`
3. **安装依赖**：`pnpm install`
4. **构建前端**：`pnpm build`
5. **部署至 Cloudflare Workers**：使用 Wrangler CLI 发布后端服务
6. **部署至 Cloudflare Pages**：上传 `dist` 目录

#### 数据库初始化
若未配置 `INIT_URL`，需手动访问 `https://your-domain/api/init/your-jwt-secret` 初始化数据库。

```mermaid
flowchart TD
A[代码推送到 GitHub] --> B{触发 GitHub Action}
B --> C[检出代码]
C --> D[安装 pnpm 依赖]
D --> E[执行 pnpm build]
E --> F[构建成功?]
F --> |是| G[部署至 Cloudflare Pages]
F --> |否| H[发送失败通知]
G --> I[部署后端 Worker]
I --> J[初始化数据库 (可选)]
J --> K[部署完成]
```

**Diagram sources**
- [github-action.md](file://doc/github-action.md#L0-L37)

**Section sources**
- [github-action.md](file://doc/github-action.md#L0-L37)

## 环境变量与安全配置

### 环境变量注入
Vite 通过 `loadEnv` 加载环境变量：
```js
const env = loadEnv(mode, process.cwd(), 'VITE')
```
仅以 `VITE_` 开头的变量会被暴露到客户端代码中。

#### 关键环境变量
| 变量名 | 用途 |
|--------|------|
| `VITE_BASE_URL` | API 请求基础地址 |
| `VITE_STATIC_URL` | 静态资源基础路径 |
| `VITE_PWA_NAME` | PWA 应用名称 |
| `VITE_OUT_DIR` | 构建输出目录 |

### 安全密钥管理
敏感信息（如 `JWT_SECRET`、`CLOUDFLARE_API_TOKEN`）应通过 GitHub Secrets 注入，避免硬编码：
```yaml
- name: Deploy to Cloudflare
  env:
    CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    JWT_SECRET: ${{ secrets.JWT_SECRET }}
```

**Section sources**
- [vite.config.js](file://mail-vue/vite.config.js#L15-L22)
- [github-action.md](file://doc/github-action.md#L4-L22)

## 缓存策略与版本控制

### 构建缓存优化
- **依赖缓存**：GitHub Actions 中使用 `actions/cache` 缓存 `node_modules` 和 `pnpm-store`，加速依赖安装
- **构建产物缓存**：可缓存 `dist` 目录，避免重复构建

### 版本控制与回滚
- **Git 分支策略**：使用 `main` 作为生产分支，`develop` 作为开发分支
- **语义化版本**：通过 `package.json` 的 `version` 字段管理前端版本
- **回滚机制**：
  - Cloudflare Pages 支持一键回滚到历史版本
  - 保留最近 10 次部署记录，便于快速恢复

**Section sources**
- [github-action.md](file://doc/github-action.md#L0-L37)

## 常见构建问题与调试方法

### 模块解析失败
**现象**：`Cannot find module '@components/button'`  
**原因**：路径别名未正确解析  
**解决**：
1. 确认 `vite.config.js` 中 `@` 别名指向 `src`
2. 检查 `jsconfig.json` 是否配置路径映射
3. 重启 Vite 开发服务器

### 资源路径错误
**现象**：CSS 或图片 404  
**原因**：`base` 路径配置不正确  
**解决**：
1. 检查 `VITE_STATIC_URL` 是否设置
2. 若部署在子目录，确保 `base` 以 `/` 结尾（如 `/mail/`）
3. 清理 `dist` 目录后重新构建

### 环境变量未生效
**现象**：`import.meta.env.VITE_BASE_URL` 为 `undefined`  
**解决**：
1. 确保变量以 `VITE_` 开头
2. 检查 `.env.[mode]` 文件是否存在且格式正确
3. 重新运行构建命令

### PWA 图标缺失
**现象**：PWA 安装后图标不显示  
**解决**：
1. 确认 `public/mail-pwa.png` 文件存在
2. 检查 `vite.config.js` 中 `manifest.icons.src` 路径
3. 构建后验证 `dist` 目录是否包含该文件

**Section sources**
- [vite.config.js](file://mail-vue/vite.config.js#L16-L24)
- [jsconfig.json](file://mail-vue/jsconfig.json#L0-L7)

## 最佳实践建议
1. **统一构建命令**：始终使用 `pnpm` 保持依赖一致性
2. **环境隔离**：为 dev、staging、prod 配置独立的 `.env` 文件
3. **预览构建产物**：使用 `vite preview` 在本地验证构建结果
4. **最小化 `dist` 内容**：通过 `assetsInclude` 精确控制包含的资源
5. **监控构建时长**：优化依赖和插件以提升 CI/CD 效率
6. **定期清理 Secrets**：轮换 API 密钥并审计访问权限