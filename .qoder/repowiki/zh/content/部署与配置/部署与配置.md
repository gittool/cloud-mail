# 部署与配置

<cite>
**本文档中引用的文件**  
- [wrangler.toml](file://mail-worker/wrangler.toml)
- [wrangler-dev.toml](file://mail-worker/wrangler-dev.toml)
- [wrangler-test.toml](file://mail-worker/wrangler-test.toml)
- [wrangler-action.toml](file://mail-worker/wrangler-action.toml)
- [vite.config.js](file://mail-vue/vite.config.js)
- [init.js](file://mail-vue/src/init/init.js)
- [init-api.js](file://mail-worker/src/api/init-api.js)
- [init.js](file://mail-worker/src/init/init.js)
- [constant.js](file://mail-worker/src/const/constant.js)
- [github-action.md](file://doc/github-action.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构概览](#项目结构概览)
3. [Wrangler 配置详解](#wrangler-配置详解)
4. [前端开发配置](#前端开发配置)
5. [系统初始化流程](#系统初始化流程)
6. [域名与SSL配置](#域名与ssl配置)
7. [CI/CD与环境隔离](#cicd与环境隔离)
8. [常见部署问题排查](#常见部署问题排查)
9. [总结](#总结)

## 简介
本指南旨在为开发者提供从本地开发到生产环境部署 cloud-mail 系统的完整流程。涵盖核心配置、初始化机制、前后端联调、域名绑定、CI/CD集成及故障排查等内容，确保系统稳定高效运行。

## 项目结构概览
cloud-mail 项目由两个主要模块组成：
- **mail-vue**：前端 Vue.js 应用，位于 `mail-vue` 目录
- **mail-worker**：后端 Cloudflare Worker 服务，位于 `mail-worker` 目录

此外包含文档目录 `doc` 和根级配置文件。

**Section sources**
- [README.md](file://README.md)

## Wrangler 配置详解
Wrangler 是 Cloudflare Workers 的 CLI 工具，通过 `.toml` 文件管理不同环境的资源配置。

### D1 数据库绑定
在 `wrangler.toml` 中通过 `d1_databases` 字段绑定 D1 数据库实例：
```toml
[[d1_databases]]
binding = "DB"
database_name = "cloud-mail-db"
database_id = "your-database-id"
```

### KV 命名空间配置
KV 用于存储键值对数据（如系统配置、会话信息）：
```toml
[[kv_namespaces]]
binding = "CONFIG_KV"
id = "config-kv-id"
preview_id = "config-kv-preview-id"
```

### R2 存储桶配置
R2 用于存储邮件附件等二进制文件：
```toml
[[r2_buckets]]
binding = "ATTACHMENT_BUCKET"
bucket_name = "cloud-mail-attachments"
preview_bucket_name = "cloud-mail-attachments-preview"
```

### 环境变量配置
敏感信息如 API 密钥通过 `vars` 字段配置：
```toml
[vars]
RESEND_API_KEY = "your-resend-api-key"
TURNSTILE_SECRET = "your-turnstile-secret"
INIT_SECRET = "your-init-secret"
```

### 多环境配置文件
项目提供多个环境专用配置：
- `wrangler-dev.toml`：开发环境
- `wrangler-test.toml`：测试环境
- `wrangler-action.toml`：CI/CD 环境
- `wrangler.toml`：生产环境

**Section sources**
- [wrangler.toml](file://mail-worker/wrangler.toml#L1-L50)
- [wrangler-dev.toml](file://mail-worker/wrangler-dev.toml#L1-L50)
- [wrangler-test.toml](file://mail-worker/wrangler-test.toml#L1-L50)
- [wrangler-action.toml](file://mail-worker/wrangler-action.toml#L1-L50)

## 前端开发配置
### Vite 代理配置
`vite.config.js` 中配置代理以支持前后端联调：
```js
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8787',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})
```
该配置将前端 `/api` 请求代理至本地 Worker 开发服务器（默认端口 8787），实现无缝联调。

**Section sources**
- [vite.config.js](file://mail-vue/vite.config.js#L10-L20)

## 系统初始化流程
系统通过特定接口触发数据库初始化和默认数据插入。

### 初始化接口
`/init/:secret` 接口由 `init-api.js` 实现，验证传入的 secret 后调用初始化服务：
```js
app.post('/init/:secret', async (c) => {
  const { secret } = c.req.param()
  if (secret !== INIT_SECRET) {
    return c.json({ success: false, msg: 'Invalid secret' }, 403)
  }
  await initService.initialize()
  return c.json({ success: true })
})
```

### 初始化逻辑
`init.js` 服务负责创建数据库表并插入默认数据：
- 创建用户、角色、权限、邮件等核心表
- 插入管理员账户和默认系统设置
- 初始化 KV 和 R2 的必要结构

前端通过 `init.js` 加载系统配置，动态获取 API 地址、功能开关等信息。

**Section sources**
- [init-api.js](file://mail-worker/src/api/init-api.js#L15-L40)
- [init.js](file://mail-worker/src/init/init.js#L1-L100)
- [init.js](file://mail-vue/src/init/init.js#L1-L50)
- [constant.js](file://mail-worker/src/const/constant.js#L5-L20)

## 域名与SSL配置
### 自定义域名绑定
在 Cloudflare 控制台中：
1. 进入 Workers & Pages 页面
2. 选择对应 Worker
3. 在 "Triggers" -> "Custom Domains" 中添加域名
4. 按提示配置 DNS CNAME 记录

### SSL 证书
Cloudflare 自动为绑定的域名提供免费 SSL 证书（Universal SSL），支持 HTTPS 访问。建议在 "SSL/TLS" 设置中启用 "Full" 或 "Strict" 模式以增强安全性。

**Section sources**
- [README.md](file://README.md#L50-L70)

## CI/CD与环境隔离
### GitHub Actions 集成
`doc/github-action.md` 提供了 CI/CD 配置说明。通过 GitHub Actions 实现自动化部署：
- 推送至 `dev` 分支 → 部署到开发环境
- 推送至 `test` 分支 → 部署到测试环境
- 推送至 `main` 分支 → 部署到生产环境

使用 `wrangler-action.toml` 作为 CI/CD 环境的配置文件，确保与生产环境一致。

### 环境隔离最佳实践
1. 为每个环境使用独立的 D1 数据库、KV 命名空间和 R2 存储桶
2. 通过不同的 `.toml` 文件管理各环境配置
3. 敏感信息（API Key、Secret）通过 GitHub Secrets 注入，避免硬编码
4. 在代码中通过环境变量区分行为（如日志级别、功能开关）

**Section sources**
- [github-action.md](file://doc/github-action.md#L1-L100)
- [wrangler-action.toml](file://mail-worker/wrangler-action.toml#L1-L50)

## 常见部署问题排查
### 部署错误排查清单
| 问题现象 | 可能原因 | 解决方案 |
|--------|--------|--------|
| Worker 部署失败 | Wrangler 配置错误 | 检查 `wrangler.toml` 语法及资源 ID 是否正确 |
| API 请求 404 | 路由未正确注册 | 检查 `index.js` 中路由定义与 API 文件导入 |
| 数据库连接失败 | D1 绑定配置错误 | 确认 `binding` 名称与代码中使用的一致 |
| KV/R2 访问拒绝 | 命名空间 ID 错误 | 核对 `kv_namespaces` 和 `r2_buckets` 的 ID |
| 初始化接口返回 403 | Secret 不匹配 | 检查 `INIT_SECRET` 环境变量与请求参数 |
| 前端无法联调 | 代理配置错误 | 确认 `vite.config.js` 代理目标地址和路径重写规则 |
| 邮件发送失败 | Resend API Key 无效 | 更新 `RESEND_API_KEY` 并验证权限 |
| Turnstile 验证失败 | Secret 配置错误 | 检查 `TURNSTILE_SECRET` 是否正确 |

### 日志调试
使用 `console.log()` 输出关键信息，并在 Cloudflare 仪表板的 "Logs" 中查看执行详情。

**Section sources**
- [wrangler.toml](file://mail-worker/wrangler.toml#L60-L80)
- [init-api.js](file://mail-worker/src/api/init-api.js#L30-L40)
- [vite.config.js](file://mail-vue/vite.config.js#L15-L20)

## 总结
cloud-mail 的部署与配置涉及多个云服务组件的协同工作。通过合理的 Wrangler 配置、清晰的环境隔离策略和完善的 CI/CD 流程，可确保系统从开发到生产的平滑过渡。遵循本文档的最佳实践，能有效提升部署效率和系统稳定性。